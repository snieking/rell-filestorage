---
language: generic
jdk: "openjdk8"
node_js: "node"

dist: trusty

services:
  - postgresql

before_script:
  - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 762E3157
  - npm i yarn
  - bash filechain/rell/install-postgres-10.sh
  - psql -c "create role postchain LOGIN ENCRYPTED PASSWORD 'postchain';" -U postgres
  - psql -c "create database filestorage;" -U postgres
  - psql -c "grant ALL ON DATABASE filestorage TO postchain;" -U postgres

cache:
  pip: true
  directories:
    - test/node_modules

script:
  - cd filehub/rell
  - ./download-binaries.sh
  - ./build.sh
  - ./run-dev-node.sh &
  - cd ../../filechain/rell
  - ./download-binaries.sh
  - sed -i "s/FILEHUB_BRID/$(cat ../../filehub/rell/target/blockchains/1/brid.txt)/g" run.xml
  - ./build.sh
  - ./run-dev-node.sh &
  - cd ../../test
  - npm install
  - npm run test
